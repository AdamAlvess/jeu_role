<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/assets/favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="/assets/favicon.png" />
  <title>Personnalisation du personnage</title>
  <link rel="stylesheet" href="./css/style_perso_card.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
  <nav class="main-nav">
    <ul>
      <li><a href="/home.html">ACCUEIL</a></li>
      <li><a href="/propos.html">À PROPOS</a></li>
      <li><a href="/explore.html">EXPLORER</a></li>
    </ul>
  </nav>

  <div class="container">
    <h1>Personnalise ton personnage</h1>

    <div class="form-section">
      <form id="characterForm">
        <label for="name">Nom :</label>
        <input type="text" id="name" placeholder="Ex: Arkan">

        <label for="raceSelect">Race :</label>
        <select id="raceSelect">
          <option value="Humain">Humain</option>
          <option value="Elfe">Elfe</option>
          <option value="Orque">Orque</option>
          <option value="Nain">Nain</option>
          <option value="Démon">Démon</option>
        </select>

        <div id="customRaceContainer" style="display:none;">
          <label for="raceInput">Race personnalisée :</label>
          <input type="text" id="raceInput" placeholder="Ex: Dragon">
        </div>

        <button type="button" id="toggleRaceInput">Ajout race</button>

        <label for="force">Force :</label>
        <div class="stat-launcher" data-stat="force">
          <div class="canon-zone">
            <img src="/assets/biceps.png" alt="Force" class="stat-trigger" />
            <div class="charge-indicator"></div>
          </div>
          <div class="target-line">
            <div class="ball"></div>
            <div class="scale">
              <!-- graduations -->
              <span>1</span><span>5</span><span>10</span><span>15</span><span>19</span>
            </div>
          </div>
          <span class="stat-value" id="forceValue">?</span>
        </div>

        <label for="agilite">Agilité :</label>
        <input type="number" id="agilite" min="0" max="20">

        <label for="dexterite">Dextérité :</label>
        <input type="number" id="dexterite" min="0" max="20">

        <label for="perception">Perception :</label>
        <input type="number" id="perception" min="0" max="20">

        <label for="constitution">Constitution :</label>
        <input type="number" id="constitution" min="0" max="20">

        <label for="charisme">Charisme :</label>
        <input type="number" id="charisme" min="0" max="20">

        <label for="intelligence">Intelligence :</label>
        <input type="number" id="intelligence" min="0" max="20">
        <div style="text-align:center;">
            <button type="submit">Valider</button>
        </div>
      </form>

    </div>

    <div class="card-section" id="characterCard" style="display:none;">
      <h2>Carte du personnage</h2>
      <p><strong>Nom :</strong> <span id="cardName"></span></p>
      <p><strong>Race :</strong> <span id="cardRace"></span></p>
      <p><strong>Force :</strong> <span id="cardForce"></span></p>
      <p><strong>Agilité :</strong> <span id="cardAgilite"></span></p>
      <p><strong>Dextérité :</strong> <span id="cardDexterite"></span></p>
      <p><strong>Perception :</strong> <span id="cardPerception"></span></p>
      <p><strong>Constitution :</strong> <span id="cardConstitution"></span></p>
      <p><strong>Charisme :</strong> <span id="cardCharisme"></span></p>
      <p><strong>Intelligence :</strong> <span id="cardIntelligence"></span></p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDnrds31zJ9YQ4ldmkPWBrlSwHo4to_BE4",
      authDomain: "jeurole-16332.firebaseapp.com",
      projectId: "jeurole-16332",
      storageBucket: "jeurole-16332.appspot.com",
      messagingSenderId: "465433430644",
      appId: "1:465433430644:web:6d242f91e2435632fd9f21",
      databaseURL: "https://jeurole-16332-default-rtdb.europe-west1.firebasedatabase.app"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const pseudo = sessionStorage.getItem("pseudo");

    document.getElementById("toggleRaceInput").addEventListener("click", () => {
      const select = document.getElementById("raceSelect");
      const inputContainer = document.getElementById("customRaceContainer");

      if (select.style.display !== "none") {
        select.style.display = "none";
        inputContainer.style.display = "block";
      } else {
        select.style.display = "block";
        inputContainer.style.display = "none";
      }
    });

    const form = document.getElementById("characterForm");
    const card = document.getElementById("characterCard");

    form.addEventListener("submit", function(e) {
      e.preventDefault();

      const nom = document.getElementById("name").value;
      const race = document.getElementById("raceInput").value || document.getElementById("raceSelect").value;
      const force = parseInt(document.getElementById("force").value);
      const agilite = parseInt(document.getElementById("agilite").value);
      const dexterite = parseInt(document.getElementById("dexterite").value);
      const perception = parseInt(document.getElementById("perception").value);
      const constitution = parseInt(document.getElementById("constitution").value);
      const charisme = parseInt(document.getElementById("charisme").value);
      const intelligence = parseInt(document.getElementById("intelligence").value);

      document.getElementById("cardName").textContent = nom;
      document.getElementById("cardRace").textContent = race;
      document.getElementById("cardForce").textContent = force;
      document.getElementById("cardAgilite").textContent = agilite;
      document.getElementById("cardDexterite").textContent = dexterite;
      document.getElementById("cardPerception").textContent = perception;
      document.getElementById("cardConstitution").textContent = constitution;
      document.getElementById("cardCharisme").textContent = charisme;
      document.getElementById("cardIntelligence").textContent = intelligence;

      card.style.display = "block";

      if (!pseudo) {
        alert("Pseudo non trouvé !");
        return;
      }

      const newCharacterRef = db.ref(`user/${pseudo}/personnages`).push();
      const characterId = newCharacterRef.key;

      newCharacterRef.set({
        nom, race, force, agilite, dexterite, perception,
        constitution, charisme, intelligence, niveau: 1
      }).then(() => {
        sessionStorage.setItem("selectedPersoId", characterId);
        window.location.href = "jeu.html";
      }).catch(error => {
        console.error("❌ Erreur Firebase :", error);
      });
    });

    document.querySelectorAll(".stat-launcher").forEach(launcher => {
    const trigger = launcher.querySelector(".stat-trigger");
    const chargeBar = launcher.querySelector(".charge-indicator");
    const ball = launcher.querySelector(".ball");
    const valueDisplay = launcher.querySelector(".stat-value");
    const statKey = launcher.dataset.stat;

    let charge = 0;
    let charging = false;
    let chargeInterval;

    trigger.addEventListener("mousedown", startCharge);
    trigger.addEventListener("touchstart", startCharge);

    document.addEventListener("mouseup", releaseCharge);
    document.addEventListener("touchend", releaseCharge);

    function startCharge(e) {
      e.preventDefault();
      if (charging) return;
      charging = true;
      charge = 0;
      chargeBar.style.height = "0%";
      trigger.style.transform = "rotate(-30deg)";
      chargeInterval = setInterval(() => {
        charge = Math.min(charge + 1, 100);
        chargeBar.style.height = `${charge}%`;
      }, 20);
    }

    function releaseCharge() {
      if (!charging) return;
      charging = false;
      clearInterval(chargeInterval);
      trigger.style.transform = "rotate(0deg)";

      const statValue = Math.floor((charge / 100) * 18) + 1;
      valueDisplay.textContent = statValue;

      const lineWidth = launcher.querySelector(".target-line").offsetWidth;
      const maxX = lineWidth - 14;
      const peakHeight = 60 + (charge / 100) * 40;
      const duration = 1000;

      ball.style.display = "block";
      ball.style.top = "0px";
      ball.style.left = "0px";

      let start = null;
      function animateBall(timestamp) {
        if (!start) start = timestamp;
        const progress = timestamp - start;
        const t = Math.min(progress / duration, 1);

        const x = t * maxX;
        const y = peakHeight * (1 - Math.pow(2 * t - 1, 2)); // parabole

        ball.style.left = `${x}px`;
        ball.style.top = `${60 - y}px`;

        if (t < 1) {
          requestAnimationFrame(animateBall);
        } else {
          if (pseudo) {
            db.ref(`user/${pseudo}/tempStats/${statKey}`).set(statValue)
              .catch(err => console.error(`Erreur mise à jour ${statKey} :`, err));
          }
        }
      }

      requestAnimationFrame(animateBall);
    }
  });
  </script>
</body>
</html>